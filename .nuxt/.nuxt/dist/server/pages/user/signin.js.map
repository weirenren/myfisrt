{"version":3,"file":"pages/user/signin.js","sources":["webpack:///./components/GithubLogin.vue?13a7","webpack:///./components/GithubLogin.vue","webpack:///./components/GithubLogin.vue?cfad","webpack:///./components/GithubLogin.vue?3d1d","webpack:///./components/QqLogin.vue?842e","webpack:///./components/QqLogin.vue","webpack:///./components/QqLogin.vue?6354","webpack:///./components/QqLogin.vue?b7a2","webpack:///./pages/user/signin.vue?5ccc","webpack:///./pages/user/signin.vue","webpack:///./pages/user/signin.vue?0960","webpack:///./pages/user/signin.vue?f622","webpack:///./common/utils.js"],"sourcesContent":["var render = function () {var _vm=this;var _h=_vm.$createElement;var _c=_vm._self._c||_h;return _c('a',{staticClass:\"is-black\",class:{ button: _vm.isButton },on:{\"click\":_vm.githubLogin}},[_vm._ssrNode(\"<i class=\\\"iconfont icon-github\\\" data-v-60f12e5b></i> \\n  <strong data-v-60f12e5b>\"+_vm._ssrEscape(_vm._s(_vm.title))+\"</strong>\")])}\nvar staticRenderFns = []\n\nexport { render, staticRenderFns }","//\n//\n//\n//\n//\n//\n//\n\nexport default {\n  name: 'GithubLogin',\n  props: {\n    title: {\n      type: String,\n      default: 'Github 登录'\n    },\n    refUrl: {\n      // 登录来源地址，控制登录成功之后要跳到该地址\n      type: String,\n      default: ''\n    },\n    isButton: {\n      type: Boolean,\n      default: true\n    }\n  },\n  data() {\n    return {\n      refUrlValue: this.refUrl\n    }\n  },\n  methods: {\n    async githubLogin() {\n      try {\n        if (!this.refUrlValue && process.client) {\n          // 如果没配置refUrl，那么取当前地址\n          this.refUrlValue = window.location.pathname\n        }\n        const ret = await this.$axios.get('/api/login/github/authorize', {\n          params: {\n            ref: this.refUrlValue\n          }\n        })\n        window.location = ret.url\n      } catch (e) {\n        console.error(e)\n        this.$toast.error('登录失败：' + (e.message || e))\n      }\n    }\n  }\n}\n","import mod from \"-!../node_modules/_babel-loader@8.1.0@babel-loader/lib/index.js??ref--2-0!../node_modules/_vue-loader@15.9.3@vue-loader/lib/index.js??vue-loader-options!./GithubLogin.vue?vue&type=script&lang=js&\"; export default mod; export * from \"-!../node_modules/_babel-loader@8.1.0@babel-loader/lib/index.js??ref--2-0!../node_modules/_vue-loader@15.9.3@vue-loader/lib/index.js??vue-loader-options!./GithubLogin.vue?vue&type=script&lang=js&\"","import { render, staticRenderFns } from \"./GithubLogin.vue?vue&type=template&id=60f12e5b&scoped=true&\"\nimport script from \"./GithubLogin.vue?vue&type=script&lang=js&\"\nexport * from \"./GithubLogin.vue?vue&type=script&lang=js&\"\nfunction injectStyles (context) {\n  \n  \n}\n\n/* normalize component */\nimport normalizer from \"!../node_modules/_vue-loader@15.9.3@vue-loader/lib/runtime/componentNormalizer.js\"\nvar component = normalizer(\n  script,\n  render,\n  staticRenderFns,\n  false,\n  injectStyles,\n  \"60f12e5b\",\n  \"c737519e\"\n  \n)\n\nexport default component.exports","var render = function () {var _vm=this;var _h=_vm.$createElement;var _c=_vm._self._c||_h;return _c('a',{staticClass:\"is-info\",class:{ button: _vm.isButton },on:{\"click\":_vm.qqLogin}},[_vm._ssrNode(\"<i class=\\\"iconfont icon-qq\\\" data-v-46cf9fdf></i> \\n  <strong data-v-46cf9fdf>\"+_vm._ssrEscape(_vm._s(_vm.title))+\"</strong>\")])}\nvar staticRenderFns = []\n\nexport { render, staticRenderFns }","//\n//\n//\n//\n//\n//\n//\n\nexport default {\n  name: 'QQLogin',\n  props: {\n    title: {\n      type: String,\n      default: 'QQ 登录'\n    },\n    refUrl: {\n      // 登录来源地址，控制登录成功之后要跳到该地址\n      type: String,\n      default: ''\n    },\n    isButton: {\n      type: Boolean,\n      default: true\n    }\n  },\n  methods: {\n    async qqLogin() {\n      try {\n        if (!this.refUrlValue && process.client) {\n          // 如果没配置refUrl，那么取当前地址\n          this.refUrlValue = window.location.pathname\n        }\n        const ret = await this.$axios.get('/api/login/qq/authorize', {\n          params: {\n            ref: this.refUrlValue\n          }\n        })\n        window.location = ret.url\n      } catch (e) {\n        console.error(e)\n        this.$toast.error('登录失败：' + (e.message || e))\n      }\n    }\n  }\n}\n","import mod from \"-!../node_modules/_babel-loader@8.1.0@babel-loader/lib/index.js??ref--2-0!../node_modules/_vue-loader@15.9.3@vue-loader/lib/index.js??vue-loader-options!./QqLogin.vue?vue&type=script&lang=js&\"; export default mod; export * from \"-!../node_modules/_babel-loader@8.1.0@babel-loader/lib/index.js??ref--2-0!../node_modules/_vue-loader@15.9.3@vue-loader/lib/index.js??vue-loader-options!./QqLogin.vue?vue&type=script&lang=js&\"","import { render, staticRenderFns } from \"./QqLogin.vue?vue&type=template&id=46cf9fdf&scoped=true&\"\nimport script from \"./QqLogin.vue?vue&type=script&lang=js&\"\nexport * from \"./QqLogin.vue?vue&type=script&lang=js&\"\nfunction injectStyles (context) {\n  \n  \n}\n\n/* normalize component */\nimport normalizer from \"!../node_modules/_vue-loader@15.9.3@vue-loader/lib/runtime/componentNormalizer.js\"\nvar component = normalizer(\n  script,\n  render,\n  staticRenderFns,\n  false,\n  injectStyles,\n  \"46cf9fdf\",\n  \"cb6089d8\"\n  \n)\n\nexport default component.exports","var render = function () {var _vm=this;var _h=_vm.$createElement;var _c=_vm._self._c||_h;return _c('section',{staticClass:\"main\"},[_vm._ssrNode(\"<div class=\\\"container\\\">\",\"</div>\",[_vm._ssrNode(\"<div class=\\\"main-body\\\">\",\"</div>\",[_vm._ssrNode(\"<div class=\\\"widget\\\">\",\"</div>\",[_vm._ssrNode(\"<div class=\\\"widget-header\\\">\\n          登录\\n        </div> \"),_vm._ssrNode(\"<div class=\\\"widget-content\\\">\",\"</div>\",[_vm._ssrNode(\"<div class=\\\"field\\\"><label class=\\\"label\\\">用户名/邮箱</label> <div class=\\\"control has-icons-left\\\"><input type=\\\"text\\\" placeholder=\\\"请输入用户名或邮箱\\\"\"+(_vm._ssrAttr(\"value\",(_vm.username)))+\" class=\\\"input is-success\\\"> <span class=\\\"icon is-small is-left\\\"><i class=\\\"iconfont icon-username\\\"></i></span></div></div> <div class=\\\"field\\\"><label class=\\\"label\\\">密码</label> <div class=\\\"control has-icons-left\\\"><input type=\\\"password\\\" placeholder=\\\"请输入密码\\\"\"+(_vm._ssrAttr(\"value\",(_vm.password)))+\" class=\\\"input\\\"> <span class=\\\"icon is-small is-left\\\"><i class=\\\"iconfont icon-password\\\"></i></span></div></div> <div class=\\\"field\\\"><label class=\\\"label\\\">验证码</label> <div class=\\\"control has-icons-left\\\"><div class=\\\"field is-horizontal\\\"><div class=\\\"field\\\"><input type=\\\"text\\\" placeholder=\\\"验证码\\\"\"+(_vm._ssrAttr(\"value\",(_vm.captchaCode)))+\" class=\\\"input\\\" style=\\\"max-width: 150px; margin-right: 20px;\\\"> <span class=\\\"icon is-small is-left\\\"><i class=\\\"iconfont icon-captcha\\\"></i></span></div> \"+((_vm.captchaUrl)?(\"<div class=\\\"field\\\"><a><img\"+(_vm._ssrAttr(\"src\",_vm.captchaUrl))+\" style=\\\"height: 40px;\\\"></a></div>\"):\"<!---->\")+\"</div></div></div> \"),_vm._ssrNode(\"<div class=\\\"field\\\">\",\"</div>\",[_vm._ssrNode(\"<div class=\\\"control\\\">\",\"</div>\",[_vm._ssrNode(\"<button class=\\\"button is-success\\\">\\n                登录\\n              </button> \"),_c('github-login',{attrs:{\"ref-url\":_vm.ref}}),_vm._ssrNode(\" \"),_c('qq-login',{attrs:{\"ref-url\":_vm.ref}}),_vm._ssrNode(\" \"),_c('nuxt-link',{staticClass:\"button is-text\",attrs:{\"to\":\"/user/signup\"}},[_vm._v(\"\\n                没有账号？点击这里去注册>>\\n              \")])],2)])],2)],2)])])])}\nvar staticRenderFns = []\n\nexport { render, staticRenderFns }","//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n\nimport utils from '~/common/utils'\nimport GithubLogin from '~/components/GithubLogin'\nimport QqLogin from '~/components/QqLogin'\nexport default {\n  components: {\n    GithubLogin,\n    QqLogin\n  },\n  asyncData({ params, query }) {\n    return {\n      ref: query.ref\n    }\n  },\n  data() {\n    return {\n      username: '',\n      password: '',\n      captchaId: '',\n      captchaUrl: '',\n      captchaCode: ''\n    }\n  },\n  computed: {\n    currentUser() {\n      return this.$store.state.user.current\n    },\n    isLogin() {\n      return !!this.currentUser\n    }\n  },\n  mounted() {\n    if (this.redirectIfLogined()) {\n      return\n    }\n    this.showCaptcha()\n  },\n  methods: {\n    async submitLogin() {\n      try {\n        if (!this.username) {\n          this.$toast.error('请输入用户名或邮箱')\n          return\n        }\n        if (!this.password) {\n          this.$toast.error('请输入密码')\n          return\n        }\n        if (!this.captchaCode) {\n          this.$toast.error('请输入验证码')\n          return\n        }\n        const user = await this.$store.dispatch('user/signin', {\n          captchaId: this.captchaId,\n          captchaCode: this.captchaCode,\n          username: this.username,\n          password: this.password,\n          ref: this.ref\n        })\n        if (this.ref) {\n          // 跳到登录前\n          utils.linkTo(this.ref)\n        } else {\n          // 跳到个人主页\n          utils.linkTo('/user/' + user.id)\n        }\n      } catch (e) {\n        this.$toast.error(e.message || e)\n        await this.showCaptcha()\n      }\n    },\n    async showCaptcha() {\n      try {\n        const ret = await this.$axios.get('/api/captcha/request', {\n          params: {\n            captchaId: this.captchaId || ''\n          }\n        })\n        this.captchaId = ret.captchaId\n        this.captchaUrl = ret.captchaUrl\n      } catch (e) {\n        this.$toast.error(e.message || e)\n      }\n    },\n    /**\n     * 如果已经登录了，那么直接跳转\n     * @returns {boolean}\n     */\n    redirectIfLogined() {\n      if (this.isLogin) {\n        const me = this\n        this.$toast.success('登录成功！', {\n          duration: 1000,\n          keepOnHover: false,\n          position: 'top-center',\n          onComplete() {\n            if (me.ref && !utils.isSigninUrl(me.ref)) {\n              utils.linkTo(me.ref)\n            } else {\n              utils.linkTo('/')\n            }\n          }\n        })\n        return true\n      }\n      return false\n    }\n  },\n  head() {\n    return {\n      title: this.$siteTitle('登录')\n    }\n  }\n}\n","import mod from \"-!../../node_modules/_babel-loader@8.1.0@babel-loader/lib/index.js??ref--2-0!../../node_modules/_vue-loader@15.9.3@vue-loader/lib/index.js??vue-loader-options!./signin.vue?vue&type=script&lang=js&\"; export default mod; export * from \"-!../../node_modules/_babel-loader@8.1.0@babel-loader/lib/index.js??ref--2-0!../../node_modules/_vue-loader@15.9.3@vue-loader/lib/index.js??vue-loader-options!./signin.vue?vue&type=script&lang=js&\"","import { render, staticRenderFns } from \"./signin.vue?vue&type=template&id=7994d4c0&\"\nimport script from \"./signin.vue?vue&type=script&lang=js&\"\nexport * from \"./signin.vue?vue&type=script&lang=js&\"\n\n\n/* normalize component */\nimport normalizer from \"!../../node_modules/_vue-loader@15.9.3@vue-loader/lib/runtime/componentNormalizer.js\"\nvar component = normalizer(\n  script,\n  render,\n  staticRenderFns,\n  false,\n  null,\n  null,\n  \"43a806c7\"\n  \n)\n\nexport default component.exports","import Cookies from 'js-cookie'\nclass Utils {\n  getCity() {\n    const city = Cookies.get('city')\n    if (city) {\n      return city\n    }\n    return '北京'\n  }\n\n  setCity(city) {\n    return Cookies.set('city', city)\n  }\n\n  linkTo(path) {\n    window.location = path\n    // 这里使用$router.push会导致跳转页面之后window.vditor对象undefined，原因未知\n    // window.$nuxt.$router.push(path)\n  }\n\n  toSignin(ref) {\n    if (!ref && process.client) {\n      // 如果没配置refUrl，那么取当前地址\n      ref = window.location.pathname\n    }\n    this.linkTo('/user/signin?ref=' + encodeURIComponent(ref))\n  }\n\n  isSigninUrl(ref) {\n    return ref === '/user/signin'\n  }\n\n  isArray(sources) {\n    return Object.prototype.toString.call(sources) === '[object Array]'\n  }\n\n  isDate(sources) {\n    return (\n      {}.toString.call(sources) === '[object Date]' &&\n      sources.toString() !== 'Invalid Date' &&\n      !isNaN(sources)\n    )\n  }\n\n  isElement(sources) {\n    return !!(sources && sources.nodeName && sources.nodeType === 1)\n  }\n\n  isFunction(sources) {\n    return Object.prototype.toString.call(sources) === '[object Function]'\n  }\n\n  isNumber(sources) {\n    return (\n      Object.prototype.toString.call(sources) === '[object Number]' &&\n      isFinite(sources)\n    )\n  }\n\n  isObject(sources) {\n    return Object.prototype.toString.call(sources) === '[object Object]'\n  }\n\n  isString(sources) {\n    return Object.prototype.toString.call(sources) === '[object String]'\n  }\n\n  isBoolean(sources) {\n    return typeof sources === 'boolean'\n  }\n\n  isEmpty(content) {\n    const str = content\n    if (str === '' || str === undefined) return true\n    const regu = '^[ ]+$'\n    const re = new RegExp(regu)\n    return re.test(str)\n  }\n}\nexport default new Utils()\n"],"mappings":";;;;;;;;;AAAA;AACA;AACA;;;;;ACFA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAFA;AAIA;AACA;AACA;AACA;AAHA;AAKA;AACA;AACA;AAFA;AAVA;AACA;AAcA;AACA;AACA;AADA;AAGA;AACA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AACA;AACA;AADA;AADA;AAKA;AACA;AACA;AACA;AACA;AACA;AACA;AAlBA;AAtBA;;ACRA;;;;;ACAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;ACrBA;AACA;AACA;;;;;ACFA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAFA;AAIA;AACA;AACA;AACA;AAHA;AAKA;AACA;AACA;AAFA;AAVA;AAeA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AACA;AACA;AADA;AADA;AAKA;AACA;AACA;AACA;AACA;AACA;AACA;AAlBA;AAjBA;;ACRA;;;;;ACAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACrBA;AACA;AACA;;;;;;;;;;;;;;ACFA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAFA;AACA;AAGA;AAAA;AAAA;AAAA;AACA;AACA;AADA;AAGA;AACA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AALA;AAOA;AACA;AAAA;AACA;AACA;AACA;AACA;AAAA;AACA;AACA;AACA;AAPA;AACA;AAOA;AACA;AACA;AACA;AACA;AAAA;AACA;AACA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AACA;AACA;AACA;AACA;AAAA;AACA;AACA;AACA;AACA;AAAA;AACA;AACA;AACA;AACA;AACA;AALA;AACA;AAMA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AACA;AACA;AACA;AACA;AADA;AADA;AAKA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;;;;AAIA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAXA;AAYA;AACA;AACA;AAAA;AACA;AACA;AAtEA;AACA;AAsEA;AACA;AACA;AADA;AAGA;AACA;AA7GA;;AC1FA;;;;;ACAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;AClBA;AAAA;AAAA;AACA;AAAA;AACA;AACA;AACA;AAAA;AACA;AACA;AACA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAKA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAIA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AA7EA;AACA;AA6EA;;;;A","sourceRoot":""}